<!-- ghostcoach/ui.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>GhostCoach ‚Äî overlay</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 24px; background: #0b0b0f; color: #e5e7eb; }
    .card { background: #111318; border: 1px solid #1f2430; border-radius: 16px; padding: 20px; max-width: 760px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); }
    .title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
    .cmd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background: #0a0c12; border: 1px solid #1a1f2b; border-radius: 12px; padding: 12px; margin: 12px 0; overflow-x: auto; }
    .row { display: flex; gap: 8px; margin-top: 8px; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #2a3243; background: #161a22; color: #e5e7eb; cursor: pointer; }
    button:hover { background: #1b2130; }
    .muted { color: #9aa4b2; font-size: 13px; }
    .small { font-size: 12px; }
  </style>
</head>
<body>
  <div class="card">
    <div class="title" id="title">–ñ–¥—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞‚Ä¶</div>
    <div class="cmd" id="command">‚Äî</div>
    <div class="muted" id="explain">–û—Ç–∫—Ä–æ–π –ø–æ–¥—Å–∫–∞–∑–∫–∏ GhostCoach: –æ—Ç–ø—Ä–∞–≤—å POST –Ω–∞ /update –∏–ª–∏ –∑–∞–ø—É—Å—Ç–∏ shell hook.</div>
    <div class="row">
        <button id="copy">Copy</button>
        <button id="run">Run</button>
        <button id="explainBtn">Explain</button>
      </div>
      
      <div id="explainBox" style="display:none; margin-top:10px;">
        <div class="muted" id="explainLong" style="white-space:pre-wrap;"></div>
      </div>
      
      <div class="muted small" id="meta" style="margin-top:12px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
  </div>

  <script>
    const port = 8765;
    const titleEl = document.getElementById('title');
    const cmdEl = document.getElementById('command');
    const explainEl = document.getElementById('explain');
    const metaEl = document.getElementById('meta');
  
    const explainBox = document.getElementById('explainBox');
    const explainLongEl = document.getElementById('explainLong');
  
    document.getElementById('copy').onclick = async () => {
      const text = cmdEl.textContent;
      await navigator.clipboard.writeText(text);
      alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ: ' + text);
    };

    document.getElementById('run').onclick = async () => {
  // –ë–µ—Ä—ë–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–∑ –ø–æ–ª—è –∫–æ–º–∞–Ω–¥—ã
    let raw = cmdEl.textContent || '';

    // 1) –≤—ã–∫–∏–¥—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏-–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –ø—É—Å—Ç—ã–µ
    const cleaned = raw
        .split('\n')
        .filter(line => !/^\s*#/.test(line))
        .join('\n')
        .trim();

    if (!cleaned) {
        alert('–ù–µ—Ç –∏—Å–ø–æ–ª–Ω–∏–º–æ–π –∫–æ–º–∞–Ω–¥—ã (–æ–¥–Ω–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏).');
        return;
    }

    try {
        const res = await fetch(`http://127.0.0.1:${port}/run`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ command: cleaned })
        });
        const data = await res.json();
        if (data.ok) {
        alert('üöÄ –ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—â–µ–Ω–∞ (' + (data.backend || 'unknown') + '): ' + cleaned);
        } else {
        alert('–û—à–∏–±–∫–∞: ' + data.error);
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞ Run: ' + e);
    }
    };


  
    document.getElementById('explainBtn').onclick = () => {
      if (explainBox.style.display === 'none') {
        explainBox.style.display = 'block';
      } else {
        explainBox.style.display = 'none';
      }
    };
  
    function updateTip(payload) {
      const tip = payload.tip || {};
      titleEl.textContent = tip.title || '–ü–æ–¥—Å–∫–∞–∑–∫–∞';
      cmdEl.textContent = tip.command || '‚Äî';
      explainEl.textContent = tip.explain || '';
      explainLongEl.textContent = tip.explain_long || tip.explain || '';
      const u = payload.update || {};
      metaEl.textContent = `[${payload.ts}] ${u.cwd || ''}  $ ${u.last_cmd || ''}  (exit=${u.exit_code || 0})`;
    }
  
    const ev = new EventSource(`http://127.0.0.1:${port}/stream`);
    ev.addEventListener('tip', (e) => {
      try { updateTip(JSON.parse(e.data)); } catch (err) { console.error(err); }
    });
    ev.onerror = (e) => console.error('SSE error', e);
  
    fetch(`http://127.0.0.1:${port}/latest`)
      .then(r => r.json())
      .then((data) => {
        if (data && data.tip) updateTip(data);
      })
      .catch(console.error);
  </script>
  
</body>
</html>
